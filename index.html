<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sorrentino Show - Gestione Eventi</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;
    }
    .loading{ display:flex; justify-content:center; align-items:center; min-height:100vh; color:#fff; text-align:center; }
    .login-container{ display:none; justify-content:center; align-items:center; min-height:100vh; padding:20px; }
    .login-card{ background:#fff; border-radius:20px; padding:40px; width:100%; max-width:400px; box-shadow:0 20px 60px rgba(0,0,0,.3); }
    .logo h1{ text-align:center; font-size:32px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:30px; }
    .form-group{ margin-bottom:20px; }
    .form-label{ display:block; margin-bottom:8px; color:#2c3e50; font-weight:500; }
    .form-input,.form-select,.form-textarea{ width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:10px; font-size:16px; }
    .form-input:focus,.form-select:focus,.form-textarea:focus{ outline:none; border-color:#667eea; }
    .btn-login,.btn-registration,.btn-submit{ width:100%; padding:14px; border:none; border-radius:10px; font-size:16px; font-weight:600; cursor:pointer; color:#fff; }
    .btn-login{ background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); }
    .btn-registration{ background:#27ae60; margin-top:10px; }
    .btn-submit{ background:#27ae60; margin-top:20px; }

    .app-container{ display:none; max-width:500px; margin:0 auto; background:#fff; min-height:100vh; }
    .app-header{ background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); padding:20px; color:#fff; position:relative; }
    .header-title{ font-size:24px; font-weight:600; text-align:center; }
    .logout-btn{ position:absolute; top:20px; right:20px; background:rgba(255,255,255,.2); color:#fff; border:none; padding:8px 16px; border-radius:20px; cursor:pointer; font-size:14px; }

    .tabs{ display:flex; background:#fff; margin:0 -20px -20px -20px; padding:0 20px; border-radius:20px 20px 0 0; }
    .tab{ flex:1; padding:15px 5px; text-align:center; cursor:pointer; color:#764ba2; font-weight:500; position:relative; font-size:12px; }
    .tab.active{ color:#667eea; }
    .tab.active::after{ content:''; position:absolute; bottom:0; left:20%; right:20%; height:3px; background:#667eea; border-radius:3px; }
    .content{ padding:20px; }
    .section{ display:none; }
    .section.active{ display:block; }

    .stat-card{ background:#fff; border-radius:15px; padding:20px; margin-bottom:20px; box-shadow:0 5px 15px rgba(0,0,0,.1); }
    .stat-value{ font-size:32px; font-weight:700; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .stat-label{ color:#7f8c8d; font-size:14px; }

    .stats-row{ display:flex; gap:15px; margin-bottom:20px; }
    .stat-card-small{ flex:1; background:#fff; border-radius:10px; padding:15px; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,.1); }
    .stat-number{ font-size:24px; font-weight:700; color:#667eea; }
    .stat-label-small{ font-size:12px; color:#7f8c8d; margin-top:5px; }

    .animator-item{ background:#fff; border-radius:10px; padding:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,.05); }
    .animator-name{ font-weight:600; color:#2c3e50; }
    .animator-status{ padding:5px 12px; border-radius:20px; font-size:12px; font-weight:600; background:#d4edda; color:#155724; }

    .btn-action{ padding:12px; border:none; border-radius:10px; font-weight:600; cursor:pointer; width:100%; margin:5px 0; background:#27ae60; color:#fff; }

    .fab{ position:fixed; bottom:20px; right:20px; width:60px; height:60px; border-radius:50%; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; border:none; font-size:28px; cursor:pointer; z-index:1000; }

    .checkbox-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px; }
    .checkbox-grid label,.checkbox-label{ display:flex; align-items:center; gap:8px; font-size:14px; }

    /* Warehouse */
    .warehouse-material-item{ background:#fff; border-radius:10px; padding:15px; margin-bottom:15px; box-shadow:0 2px 10px rgba(0,0,0,.1); border-left:4px solid #27ae60; position:relative; }
    .warehouse-material-item.low-stock{ border-left-color:#f39c12; }
    .warehouse-material-item.out-of-stock{ border-left-color:#e74c3c; }
    .warehouse-material-header{ display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px; }
    .warehouse-material-left{ display:flex; align-items:center; flex:1; }
    .warehouse-material-code{ background:#667eea; color:#fff; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:600; margin-right:10px; }
    .warehouse-material-icon{ font-size:20px; margin-right:10px; }
    .warehouse-material-info{ flex:1; }
    .warehouse-material-name{ font-weight:600; color:#2c3e50; font-size:14px; }
    .warehouse-material-category{ font-size:11px; color:#7f8c8d; margin-top:2px; }
    .warehouse-material-quantity{ text-align:right; }
    .warehouse-quantity-number{ font-size:16px; font-weight:600; color:#27ae60; }
    .warehouse-quantity-number.low{ color:#f39c12; }
    .warehouse-quantity-number.zero{ color:#e74c3c; }
    .warehouse-quantity-label{ font-size:10px; color:#7f8c8d; }
    .warehouse-material-details{ font-size:11px; color:#7f8c8d; margin-top:8px; padding-top:8px; border-top:1px solid #f0f0f0; }
    .warehouse-material-actions{ position:absolute; top:15px; right:15px; }
    .warehouse-action-btn{ background:none; border:none; color:#7f8c8d; cursor:pointer; margin-left:5px; font-size:14px; }
    .warehouse-action-btn:hover{ color:#667eea; }

    .filter-tabs{ display:flex; margin-bottom:15px; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,.1); }
    .filter-tab{ flex:1; padding:8px; text-align:center; background:#fff; color:#667eea; border:none; font-size:12px; cursor:pointer; font-weight:500; }
    .filter-tab.active{ background:#667eea; color:#fff; }

    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.7); z-index:2000; justify-content:center; align-items:center; }
    .modal.active{ display:flex; }
    .modal-content{ background:#fff; border-radius:20px; padding:30px; width:90%; max-width:450px; max-height:90vh; overflow-y:auto; }
    .modal-title{ font-size:20px; font-weight:600; color:#2c3e50; margin-bottom:20px; text-align:center; }
    .modal-buttons{ display:flex; gap:10px; margin-top:20px; }
    .btn-cancel,.btn-save{ flex:1; padding:12px; border:none; border-radius:10px; font-weight:600; cursor:pointer; }
    .btn-cancel{ background:#e0e0e0; color:#7f8c8d; }
    .btn-save{ background:#667eea; color:#fff; }

    .notification{ position:fixed; top:20px; right:20px; background:#fff; padding:15px 20px; border-radius:10px; box-shadow:0 5px 20px rgba(0,0,0,.2); display:none; z-index:3000; }
    .notification.show{ display:block; }
    #notificationTitle{ font-weight:600; }
    #notificationMessage{ font-size:14px; color:#7f8c8d; }
  </style>
</head>
<body>
  <!-- Loading -->
  <div class="loading" id="loadingScreen">
    <div>
      <div style="font-size:48px; margin-bottom:20px;">üî•</div>
      <h2>Caricamento...</h2>
    </div>
  </div>

  <!-- Login -->
  <div class="login-container" id="loginScreen">
    <div class="login-card">
      <div class="logo"><h1>üéâ Sorrentino Show</h1></div>

      <div class="form-group">
        <label class="form-label">Tipo Accesso</label>
        <select class="form-select" id="userType" onchange="updateLoginHint()">
          <option value="">Seleziona...</option>
          <option value="admin">Amministratore</option>
          <option value="animator">Animatore Esistente</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" class="form-input" id="email" placeholder="email@esempio.com" />
      </div>

      <div class="form-group">
        <label class="form-label">Password</label>
        <input type="password" class="form-input" id="password" placeholder="Password" />
      </div>

      <button class="btn-login" onclick="login()" id="loginBtn">Accedi</button>

      <div style="text-align:center; margin-top:20px;">
        <button class="btn-registration" onclick="goToRegistration()">üìù Candidati come Animatore</button>
        <p style="font-size:12px; color:#7f8c8d; margin-top:8px;">Non sei ancora nel team? Compila il modulo di candidatura</p>
      </div>

      <div id="loginHint" style="text-align:center; margin-top:15px; padding:10px; background:#f0f0f0; border-radius:8px; display:none;">
        <small style="color:#666;"></small>
      </div>
    </div>
  </div>

  <!-- Admin App -->
  <div class="app-container" id="adminApp">
    <div class="app-header">
      <button class="logout-btn" onclick="logout()">Esci</button>
      <h1 class="header-title">üéâ Admin Panel</h1>
      <div class="tabs">
        <div class="tab active" onclick="switchTab('dashboard', this)">Dashboard</div>
        <div class="tab" onclick="switchTab('events', this)">Eventi</div>
        <div class="tab" onclick="switchTab('warehouse', this)">Magazzino</div>
        <div class="tab" onclick="switchTab('team', this)">Team</div>
      </div>
    </div>

    <div class="content">
      <div id="admin-dashboard" class="section active">
        <div class="stat-card">
          <div class="stat-value">0</div>
          <div class="stat-label">Eventi Oggi</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">2</div>
          <div class="stat-label">Animatori Attivi</div>
        </div>
      </div>

      <div id="admin-events" class="section">
        <div id="eventsList"></div>
        <div style="text-align:center; padding:40px 20px; color:#7f8c8d;">
          <div style="font-size:48px; margin-bottom:15px;">üìÖ</div>
          <p>Nessun evento programmato</p>
        </div>
      </div>

      <div id="admin-warehouse" class="section">
        <div class="stats-row">
          <div class="stat-card-small"><div class="stat-number" id="totalWarehouseMaterials">8</div><div class="stat-label-small">Materiali Totali</div></div>
          <div class="stat-card-small"><div class="stat-number" id="availableWarehouseMaterials">7</div><div class="stat-label-small">Disponibili</div></div>
          <div class="stat-card-small"><div class="stat-number" id="lowStockWarehouseMaterials">2</div><div class="stat-label-small">Scorte Basse</div></div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:20px;">
          <button class="btn-action" onclick="openWarehouseModal()" style="background:#27ae60;">+ Aggiungi</button>
          <button class="btn-action" onclick="exportWarehouseInventory()" style="background:#9b59b6;">üìä Export</button>
        </div>

        <div style="position:relative; margin-bottom:15px;">
          <input type="text" class="form-input" placeholder="Cerca materiali..." id="warehouseSearchInput" oninput="filterWarehouseMaterials()" style="padding-right:40px;" />
          <span style="position:absolute; right:12px; top:50%; transform:translateY(-50%); color:#7f8c8d;">üîç</span>
        </div>

        <div class="filter-tabs">
          <button class="filter-tab active" onclick="setWarehouseFilter('all', this)">Tutti</button>
          <button class="filter-tab" onclick="setWarehouseFilter('available', this)">Disponibili</button>
          <button class="filter-tab" onclick="setWarehouseFilter('low', this)">Scorte Basse</button>
        </div>

        <div id="warehouseMaterialList"></div>

        <div id="warehouseEmptyState" style="display:none; text-align:center; padding:40px 20px; color:#7f8c8d;">
          <div style="font-size:48px; margin-bottom:15px; opacity:.5;">üì¶</div>
          <h3>Nessun materiale trovato</h3>
          <p>Prova a modificare i filtri di ricerca</p>
        </div>
      </div>

      <div id="admin-team" class="section">
        <div class="animator-item">
          <div>
            <div class="animator-name">Daniele Sorrentino</div>
            <div style="font-size:12px; color:#7f8c8d;">Animatore Junior</div>
          </div>
          <div class="animator-status">Disponibile</div>
        </div>
        <div class="animator-item">
          <div>
            <div class="animator-name">Antonio Maria Sirignano</div>
            <div style="font-size:12px; color:#7f8c8d;">Animatore Junior</div>
          </div>
          <div class="animator-status">Disponibile</div>
        </div>
      </div>
    </div>

    <button class="fab" onclick="openCurrentModal()">+</button>
  </div>

  <!-- Animator Registration -->
  <div class="app-container" id="animatorApp">
    <div class="app-header">
      <button class="logout-btn" onclick="logout()">‚Üê Torna al Login</button>
      <h1 class="header-title">üë§ Candidatura</h1>
    </div>

    <div class="content">
      <div style="text-align:center; margin-bottom:30px;">
        <div style="font-size:48px; margin-bottom:15px;">üé≠</div>
        <h2 style="color:#2c3e50; margin-bottom:10px;">Diventa un Animatore</h2>
        <p style="color:#7f8c8d;">Compila il modulo per unirti al team</p>
      </div>

      <form id="registrationForm" onsubmit="submitRegistration(event)">
        <div class="form-group">
          <label class="form-label">Nome Completo *</label>
          <input type="text" class="form-input" id="regName" required />
        </div>

        <div class="form-group">
          <label class="form-label">Email *</label>
          <input type="email" class="form-input" id="regEmail" required />
        </div>

        <div class="form-group">
          <label class="form-label">Telefono *</label>
          <input type="tel" class="form-input" id="regPhone" required />
        </div>

        <div class="form-group">
          <label class="form-label">Data di Nascita *</label>
          <input type="date" class="form-input" id="regBirth" required />
        </div>

        <div class="form-group">
          <label class="form-label">Esperienza</label>
          <select class="form-select" id="regExp">
            <option>Nessuna esperienza</option>
            <option>1-2 anni</option>
            <option>3-5 anni</option>
            <option>Oltre 5 anni</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Specializzazioni</label>
          <div class="checkbox-grid">
            <label><input type="checkbox" /> Trucca-bimbi</label>
            <label><input type="checkbox" /> Palloncini</label>
            <label><input type="checkbox" /> DJ/Musica</label>
            <label><input type="checkbox" /> Giochi sportivi</label>
            <label><input type="checkbox" /> Magia</label>
            <label><input type="checkbox" /> Ballo</label>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Disponibilit√†</label>
          <div class="checkbox-grid">
            <label><input type="checkbox" /> Luned√¨</label>
            <label><input type="checkbox" /> Marted√¨</label>
            <label><input type="checkbox" /> Mercoled√¨</label>
            <label><input type="checkbox" /> Gioved√¨</label>
            <label><input type="checkbox" /> Venerd√¨</label>
            <label><input type="checkbox" /> Sabato</label>
            <label><input type="checkbox" /> Domenica</label>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Motivazione</label>
          <textarea class="form-textarea" id="regMotivation" rows="3" placeholder="Perch√© vuoi unirti al nostro team?"></textarea>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="regPrivacy" required />
            <span>Accetto il trattamento dei dati personali *</span>
          </label>
        </div>

        <button type="submit" class="btn-submit">üìù Invia Candidatura</button>
      </form>
    </div>
  </div>

  <!-- Warehouse Modal -->
  <div class="modal" id="warehouseModal">
    <div class="modal-content">
      <h2 class="modal-title" id="warehouseModalTitle">Nuovo Materiale</h2>

      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <div style="flex:1;">
          <label class="form-label">Codice</label>
          <input type="text" class="form-input" id="warehouseCode" placeholder="MT001" />
        </div>
        <div style="flex:1;">
          <label class="form-label">Icona</label>
          <input type="text" class="form-input" id="warehouseIcon" placeholder="üì¶" maxlength="2" />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Nome Materiale</label>
        <input type="text" class="form-input" id="warehouseName" required />
      </div>

      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <div style="flex:1;">
          <label class="form-label">Categoria</label>
          <select class="form-select" id="warehouseCategory" required>
            <option value="">Seleziona</option>
            <option value="Giochi">Giochi</option>
            <option value="Audio/Video">Audio/Video</option>
            <option value="Trucchi/Costumi">Trucchi/Costumi</option>
            <option value="Sport">Sport</option>
            <option value="Accessori">Accessori</option>
          </select>
        </div>
        <div style="flex:1;">
          <label class="form-label">Quantit√†</label>
          <input type="number" class="form-input" id="warehouseQuantity" min="0" value="1" required />
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <div style="flex:1;">
          <label class="form-label">Soglia minima</label>
          <input type="number" class="form-input" id="warehouseThreshold" min="0" value="2" />
        </div>
        <div style="flex:1;">
          <label class="form-label">Posizione</label>
          <input type="text" class="form-input" id="warehouseLocation" placeholder="Scaffale A1" />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Note</label>
        <textarea class="form-textarea" id="warehouseNotes" rows="2"></textarea>
      </div>

      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal('warehouseModal')">Annulla</button>
        <button class="btn-save" onclick="saveWarehouseMaterial()">Salva</button>
      </div>
    </div>
  </div>

  <!-- Movement Modal -->
  <div class="modal" id="movementModal">
    <div class="modal-content">
      <h2 class="modal-title">Movimento Materiale</h2>

      <div class="form-group">
        <label class="form-label">Materiale</label>
        <input type="text" class="form-input" id="movementMaterial" readonly />
      </div>

      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <div style="flex:1;">
          <label class="form-label">Tipo</label>
          <select class="form-select" id="movementType">
            <option value="in">Entrata</option>
            <option value="out">Uscita</option>
            <option value="adjustment">Rettifica</option>
          </select>
        </div>
        <div style="flex:1;">
          <label class="form-label">Quantit√†</label>
          <input type="number" class="form-input" id="movementQuantity" min="1" value="1" />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Motivo</label>
        <textarea class="form-textarea" id="movementReason" rows="2"></textarea>
      </div>

      <div class="modal-buttons">
        <button class="btn-cancel" onclick="closeModal('movementModal')">Annulla</button>
        <button class="btn-save" onclick="saveMovement()">Conferma</button>
      </div>
    </div>
  </div>

  <!-- Notification -->
  <div class="notification" id="notification">
    <div id="notificationTitle">Notifica</div>
    <div id="notificationMessage">Messaggio</div>
  </div>

  <script>
    // ---- State
    let currentTab = 'dashboard';
    let warehouseMaterials = [
      { id:1, code:'MT001', name:'Birilli colorati', category:'Giochi', icon:'üé≥', quantity:5, threshold:2, location:'Scaffale A1', notes:'Set completo numerato' },
      { id:2, code:'MT002', name:'Set colori e pennelli', category:'Trucchi/Costumi', icon:'üé®', quantity:3, threshold:1, location:'Armadio B2', notes:'Kit trucca-bimbi' },
      { id:3, code:'MT003', name:'Barattoli gioco', category:'Giochi', icon:'ü•§', quantity:1, threshold:3, location:'Scaffale A3', notes:'Gioco colpisci barattoli' },
      { id:4, code:'MT004', name:'Palloni gonfiabili', category:'Sport', icon:'‚öΩ', quantity:2, threshold:1, location:'Deposito C1', notes:'Per attivit√† esterne' },
      { id:5, code:'MT005', name:'Coni segnalatori', category:'Sport', icon:'üö¶', quantity:0, threshold:5, location:'Deposito C2', notes:'Da riordinare' },
      { id:6, code:'MT006', name:'Microfono wireless', category:'Audio/Video', icon:'üé§', quantity:2, threshold:1, location:'Box tecnico', notes:'Batterie incluse' },
      { id:7, code:'MT007', name:'Costumi principesse', category:'Trucchi/Costumi', icon:'üëó', quantity:4, threshold:2, location:'Armadio A1', notes:'Taglie assortite' },
      { id:8, code:'MT008', name:'Tappeto gioco', category:'Accessori', icon:'üü´', quantity:3, threshold:1, location:'Magazzino B', notes:'Lavabili' }
    ];
    let filteredWarehouseMaterials = [...warehouseMaterials];
    let currentWarehouseFilter = 'all';
    let isWarehouseEditMode = false;
    let editingWarehouseMaterial = null;

    // ---- Init
    setTimeout(() => {
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'flex';
      initializeFirebase();
    }, 1000);

    async function initializeFirebase(){
      try{
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js');
        const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');
        const { getAuth } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js');

        const firebaseConfig = {
          apiKey: "AIzaSyDSG_YYQdxWM_OXbCZNBuNKzCEV6P5vZtQ",
          authDomain: "sorrentino-turni.firebaseapp.com",
          projectId: "sorrentino-turni",
          storageBucket: "sorrentino-turni.firebasestorage.app",
          messagingSenderId: "265460676714",
          appId: "1:265460676714:web:d88b4db67d2f95ae653213"
        };
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.firebaseReady = true;
        console.log('Firebase initialized successfully');
      }catch(err){
        console.error('Firebase initialization failed:', err);
        window.firebaseReady = false;
      }
    }

    // ---- UI helpers
    function showNotification(title, message){
      document.getElementById('notificationTitle').textContent = title;
      document.getElementById('notificationMessage').textContent = message;
      document.getElementById('notification').classList.add('show');
      setTimeout(()=>document.getElementById('notification').classList.remove('show'), 3000);
    }

    function updateLoginHint(){
      const userType = document.getElementById('userType').value;
      const hint = document.getElementById('loginHint');
      const small = hint.querySelector('small');
      if(userType==='admin'){
        small.innerHTML = 'Admin: admin@sorrentino.it<br>Password: admin123';
        hint.style.display = 'block';
      }else if(userType==='animator'){
        small.innerHTML = 'Inserisci le credenziali fornite';
        hint.style.display = 'block';
      }else{
        hint.style.display = 'none';
      }
    }

    function goToRegistration(){
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('animatorApp').style.display = 'block';
      showNotification('Benvenuto!','Compila il modulo di candidatura');
    }

    function login(){
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const userType = document.getElementById('userType').value;
      if(!email || !password || !userType){
        showNotification('Errore','Compila tutti i campi');
        return;
      }
      if(email==='admin@sorrentino.it' && password==='admin123' && userType==='admin'){
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminApp').style.display = 'block';
        showNotification('Login riuscito!','Benvenuto Admin');
      }else{
        showNotification('Errore','Credenziali non valide');
      }
    }

    function logout(){
      document.getElementById('adminApp').style.display = 'none';
      document.getElementById('animatorApp').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
      document.getElementById('userType').value = '';
      updateLoginHint();
    }

    function switchTab(tabName, el){
      currentTab = tabName;
      document.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      if(el) el.classList.add('active');
      const target = document.getElementById('admin-'+tabName);
      if(target) target.classList.add('active');

      if(tabName==='warehouse'){
        renderWarehouseMaterials();
        updateWarehouseStats();
      }
    }

    function openCurrentModal(){
      switch(currentTab){
        case 'events': showNotification('Eventi','Funzionalit√† in sviluppo'); break;
        case 'warehouse': openWarehouseModal(); break;
        case 'team': showNotification('Team','Funzionalit√† in sviluppo'); break;
        default: showNotification('Info','Seleziona una sezione');
      }
    }

    // ---- Warehouse
    function renderWarehouseMaterials(){
      const container = document.getElementById('warehouseMaterialList');
      const emptyState = document.getElementById('warehouseEmptyState');
      if(filteredWarehouseMaterials.length===0){
        container.style.display='none';
        emptyState.style.display='block';
        return;
      }
      container.style.display='block';
      emptyState.style.display='none';

      container.innerHTML = filteredWarehouseMaterials.map(material=>{
        const stockStatus = material.quantity===0 ? 'out-of-stock' : (material.quantity <= material.threshold ? 'low-stock' : '');
        const qtyClass = material.quantity===0 ? 'zero' : (material.quantity <= material.threshold ? 'low' : '');
        return `
          <div class="warehouse-material-item ${stockStatus}">
            <div class="warehouse-material-actions">
              <button class="warehouse-action-btn" onclick="openMovementModal(${material.id})" title="Movimento">üìù</button>
              <button class="warehouse-action-btn" onclick="editWarehouseMaterial(${material.id})" title="Modifica">‚úèÔ∏è</button>
              <button class="warehouse-action-btn" onclick="deleteWarehouseMaterial(${material.id})" title="Elimina">üóëÔ∏è</button>
            </div>
            <div class="warehouse-material-header">
              <div class="warehouse-material-left">
                <div class="warehouse-material-code">${material.code}</div>
                <div class="warehouse-material-icon">${material.icon}</div>
                <div class="warehouse-material-info">
                  <div class="warehouse-material-name">${material.name}</div>
                  <div class="warehouse-material-category">${material.category}</div>
                </div>
              </div>
              <div class="warehouse-material-quantity">
                <div class="warehouse-quantity-number ${qtyClass}">${material.quantity}</div>
                <div class="warehouse-quantity-label">disponibili</div>
              </div>
            </div>
            <div class="warehouse-material-details">
              üìç ${material.location || 'Non specificata'} ‚Ä¢ ‚ö†Ô∏è Min: ${material.threshold} ‚Ä¢ ${material.notes || 'Nessuna nota'}
            </div>
          </div>
        `;
      }).join('');
    }

    function updateWarehouseStats(){
      const total = warehouseMaterials.length;
      const available = warehouseMaterials.filter(m=>m.quantity>0).length;
      const lowStock = warehouseMaterials.filter(m=>m.quantity>0 && m.quantity<=m.threshold).length;
      document.getElementById('totalWarehouseMaterials').textContent = total;
      document.getElementById('availableWarehouseMaterials').textContent = available;
      document.getElementById('lowStockWarehouseMaterials').textContent = lowStock;
    }

    function setWarehouseFilter(filter, el){
      currentWarehouseFilter = filter;
      document.querySelectorAll('.filter-tab').forEach(t=>t.classList.remove('active'));
      if(el) el.classList.add('active');

      switch(filter){
        case 'available': filteredWarehouseMaterials = warehouseMaterials.filter(m=>m.quantity>0); break;
        case 'low': filteredWarehouseMaterials = warehouseMaterials.filter(m=>m.quantity>0 && m.quantity<=m.threshold); break;
        default: filteredWarehouseMaterials = [...warehouseMaterials];
      }
      filterWarehouseMaterials();
    }

    function filterWarehouseMaterials(){
      const term = document.getElementById('warehouseSearchInput').value.toLowerCase();
      let base;
      switch(currentWarehouseFilter){
        case 'available': base = warehouseMaterials.filter(m=>m.quantity>0); break;
        case 'low': base = warehouseMaterials.filter(m=>m.quantity>0 && m.quantity<=m.threshold); break;
        default: base = [...warehouseMaterials];
      }
      filteredWarehouseMaterials = base.filter(m =>
        m.name.toLowerCase().includes(term) ||
        m.code.toLowerCase().includes(term) ||
        m.category.toLowerCase().includes(term)
      );
      renderWarehouseMaterials();
    }

    function openWarehouseModal(){
      isWarehouseEditMode = false;
      editingWarehouseMaterial = null;
      document.getElementById('warehouseModalTitle').textContent = 'Aggiungi Materiale';
      document.getElementById('warehouseCode').value = generateWarehouseCode();
      document.getElementById('warehouseIcon').value = 'üì¶';
      document.getElementById('warehouseQuantity').value = 1;
      document.getElementById('warehouseThreshold').value = 2;
      document.getElementById('warehouseModal').classList.add('active');
    }

    function editWarehouseMaterial(id){
      const m = warehouseMaterials.find(x=>x.id===id);
      if(!m) return;
      isWarehouseEditMode = true;
      editingWarehouseMaterial = m;
      document.getElementById('warehouseModalTitle').textContent = 'Modifica Materiale';
      document.getElementById('warehouseCode').value = m.code;
      document.getElementById('warehouseName').value = m.name;
      document.getElementById('warehouseCategory').value = m.category;
      document.getElementById('warehouseIcon').value = m.icon;
      document.getElementById('warehouseQuantity').value = m.quantity;
      document.getElementById('warehouseThreshold').value = m.threshold;
      document.getElementById('warehouseLocation').value = m.location || '';
      document.getElementById('warehouseNotes').value = m.notes || '';
      document.getElementById('warehouseModal').classList.add('active');
    }

    function deleteWarehouseMaterial(id){
      if(confirm('Sei sicuro di voler eliminare questo materiale?')){
        warehouseMaterials = warehouseMaterials.filter(m=>m.id!==id);
        setWarehouseFilter(currentWarehouseFilter);
        updateWarehouseStats();
        showNotification('Eliminato','Materiale rimosso dal magazzino');
      }
    }

    function saveWarehouseMaterial(){
      const code = document.getElementById('warehouseCode').value.trim();
      const name = document.getElementById('warehouseName').value.trim();
      const category = document.getElementById('warehouseCategory').value;
      const icon = (document.getElementById('warehouseIcon').value.trim()) || 'üì¶';
      const quantity = Number(document.getElementById('warehouseQuantity').value);
      const threshold = Number(document.getElementById('warehouseThreshold').value);
      const location = document.getElementById('warehouseLocation').value.trim();
      const notes = document.getElementById('warehouseNotes').value.trim();

      if(!name || !category || Number.isNaN(quantity) || quantity<0){
        showNotification('Errore','Compila tutti i campi obbligatori');
        return;
      }
      if(!isWarehouseEditMode && warehouseMaterials.some(m=>m.code===code)){
        showNotification('Errore','Codice gi√† esistente');
        return;
      }
      const data = { code, name, category, icon, quantity, threshold, location, notes };
      if(isWarehouseEditMode){
        Object.assign(editingWarehouseMaterial, data);
        showNotification('Aggiornato','Materiale modificato con successo');
      }else{
        data.id = Date.now();
        warehouseMaterials.push(data);
        showNotification('Aggiunto','Nuovo materiale aggiunto al magazzino');
      }
      closeModal('warehouseModal');
      setWarehouseFilter(currentWarehouseFilter);
      updateWarehouseStats();
    }

    function openMovementModal(id){
      const m = warehouseMaterials.find(x=>x.id===id);
      if(!m) return;
      document.getElementById('movementMaterial').value = `${m.code} - ${m.name}`;
      document.getElementById('movementModal').classList.add('active');
      window.currentMovementMaterial = m;
    }

    function saveMovement(){
      const type = document.getElementById('movementType').value;
      const qty = Number(document.getElementById('movementQuantity').value);
      if(!qty || qty<=0){ showNotification('Errore','Inserisci una quantit√† valida'); return; }
      const m = window.currentMovementMaterial; if(!m) return;

      if(type==='in'){ m.quantity += qty; showNotification('Movimento registrato',`Aggiunti ${qty} ${m.name}`); }
      else if(type==='out'){
        if(qty>m.quantity){ showNotification('Errore','Quantit√† insufficiente'); return; }
        m.quantity -= qty; showNotification('Movimento registrato',`Prelevati ${qty} ${m.name}`);
      }else{ m.quantity = qty; showNotification('Inventario aggiornato',`Quantit√† ${m.name} rettificata`); }

      closeModal('movementModal');
      setWarehouseFilter(currentWarehouseFilter);
      updateWarehouseStats();
    }

    function generateWarehouseCode(){
      const codes = warehouseMaterials.map(m=>m.code);
      let counter = warehouseMaterials.length + 1, code;
      do{ code = `MT${String(counter).padStart(3,'0')}`; counter++; } while(codes.includes(code));
      return code;
    }

    function exportWarehouseInventory(){
      const csv = 'Codice,Nome,Categoria,Quantit√†,Soglia,Posizione,Note\n' +
        warehouseMaterials.map(m=>`"${m.code}","${m.name}","${m.category}","${m.quantity}","${m.threshold}","${m.location||''}","${m.notes||''}"`).join('\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'inventario_magazzino.csv';
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
      showNotification('Export completato','File CSV scaricato');
    }

    function closeModal(modalId){
      if(modalId){ document.getElementById(modalId).classList.remove('active'); }
      else { document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active')); }
      // non resetto i campi automaticamente per non perdere dati non salvati
    }

    async function submitRegistration(e){
      e.preventDefault();
      const name = document.getElementById('regName').value.trim();
      const email = document.getElementById('regEmail').value.trim();
      const phone = document.getElementById('regPhone').value.trim();
      const birth = document.getElementById('regBirth').value;
      const experience = document.getElementById('regExp').value;
      const motivation = document.getElementById('regMotivation').value.trim();
      const privacy = document.getElementById('regPrivacy').checked;

      if(!name || !email || !phone || !birth){ showNotification('Errore','Compila tutti i campi obbligatori'); return; }
      if(!privacy){ showNotification('Errore','Accetta il trattamento dei dati personali'); return; }

      // et√†
      const birthDate = new Date(birth), today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const md = today.getMonth() - birthDate.getMonth();
      if(md < 0 || (md===0 && today.getDate() < birthDate.getDate())) age--;
      if(age < 16){ showNotification('Errore','Devi avere almeno 16 anni'); return; }

      // prendo le due griglie dentro il form
      const grids = document.querySelectorAll('#registrationForm .checkbox-grid');
      const specializations = grids[0] ? Array.from(grids[0].querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.closest('label').textContent.trim()) : [];
      const availability = grids[1] ? Array.from(grids[1].querySelectorAll('input[type="checkbox"]:checked')).map(cb=>cb.closest('label').textContent.trim()) : [];

      try{
        if(window.firebaseReady && window.db){
          const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js');
          const data = {
            name, email, phone,
            birthDate: birth, age, experience,
            motivation: motivation || '',
            specializations, availability,
            registeredAt: serverTimestamp(),
            status:'pending', role:'Animatore Junior', source:'Web Application', workStatus:'available'
          };
          await addDoc(collection(window.db,'animators'), data);
          showNotification('Candidatura Inviata!', `Grazie ${name}, riceverai una risposta entro 48 ore`);
          setTimeout(()=>document.getElementById('registrationForm').reset(), 1500);
        }else{
          throw new Error('Firebase non disponibile');
        }
      }catch(err){
        console.error('Error saving to Firebase:', err);
        showNotification('Errore di connessione','La candidatura non √® stata salvata. Riprova pi√π tardi.');
      }
    }

    document.addEventListener('click', (e)=>{
      if(e.target.classList.contains('modal')) closeModal();
    });
  </script>
</body>
</html>
