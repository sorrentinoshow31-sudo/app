<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sorrentino Show - Gestione Eventi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
            text-align: center;
        }

        .login-container {
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .logo h1 {
            text-align: center;
            font-size: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-login {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .app-container {
            display: none;
            max-width: 500px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            color: white;
            position: relative;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: white;
            margin: 0 -20px -20px -20px;
            padding: 0 20px;
            border-radius: 20px 20px 0 0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            color: #764ba2;
            font-weight: 500;
            position: relative;
        }

        .tab.active {
            color: #667eea;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            right: 20%;
            height: 3px;
            background: #667eea;
            border-radius: 3px;
        }

        .content {
            padding: 20px;
            min-height: calc(100vh - 150px);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }

        .btn-action {
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            width: 100%;
            margin: 5px 0;
            transition: all 0.3s ease;
        }

        .btn-start {
            background: #27ae60;
            color: white;
        }

        .btn-materials {
            background: #3498db;
            color: white;
        }

        .btn-complete {
            background: #e74c3c;
            color: white;
        }

        .btn-action:hover {
            transform: translateY(-2px);
        }

        .animator-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .animator-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .animator-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: #d4edda;
            color: #155724;
        }

        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
            z-index: 1000;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-modal {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel {
            background: #e0e0e0;
            color: #7f8c8d;
        }

        .btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: none;
            z-index: 3000;
        }

        .notification.show {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .firebase-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 10px;
            z-index: 100;
        }

        .firebase-status.connected {
            background: rgba(46, 125, 50, 0.8);
        }
    </style>
</head>
<body>
    <div class="loading" id="loadingScreen">
        <div>
            <div style="font-size: 48px; margin-bottom: 20px;">üî•</div>
            <h2>Caricamento Firebase...</h2>
            <p>Connessione al database cloud</p>
        </div>
    </div>

    <!-- Login Screen -->
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div class="logo">
                <h1>üéâ Sorrentino Show</h1>
            </div>
            
            <div class="form-group">
                <label class="form-label">Tipo Accesso</label>
                <select class="form-select" id="userType" onchange="updateLoginHint()">
                    <option value="">Seleziona...</option>
                    <option value="admin">Amministratore</option>
                    <option value="animator">Animatore</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="email" placeholder="email@esempio.com">
            </div>
            
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="password" placeholder="Password">
            </div>
            
            <button class="btn-login" onclick="login()" id="loginBtn">Accedi</button>
            
            <div id="loginHint" style="text-align: center; margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 8px; display: none;">
                <small style="color: #666;"></small>
            </div>
        </div>
    </div>

    <!-- Admin App -->
    <div class="app-container" id="adminApp">
        <div class="app-header">
            <button class="logout-btn" onclick="logout()">Esci</button>
            <h1 class="header-title">üéâ Sorrentino Show</h1>
            <div class="tabs">
                <div class="tab active" onclick="switchTab('dashboard', 'admin')">Dashboard</div>
                <div class="tab" onclick="switchTab('events', 'admin')">Eventi</div>
                <div class="tab" onclick="switchTab('team', 'admin')">Team</div>
            </div>
        </div>

        <div class="content">
            <!-- Dashboard -->
            <div id="admin-dashboard" class="section active">
                <div class="stat-card">
                    <div class="stat-value" id="todayEvents">-</div>
                    <div class="stat-label">Eventi Oggi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeAnimators">-</div>
                    <div class="stat-label">Animatori Attivi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="monthHours">-h</div>
                    <div class="stat-label">Ore Totali Mese</div>
                </div>
            </div>

            <!-- Events -->
            <div id="admin-events" class="section">
                <div id="eventsList"></div>
                <div class="empty-state" id="noEvents" style="display: none;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üìÖ</div>
                    <p>Nessun evento programmato</p>
                </div>
            </div>

            <!-- Team -->
            <div id="admin-team" class="section">
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn-action btn-start" onclick="openAnimatorModal()">
                        ‚ûï Aggiungi Animatore
                    </button>
                    <button class="btn-action btn-materials" onclick="loadTeam()">
                        üîÑ Aggiorna Team
                    </button>
                    <button class="btn-action" onclick="fixAnimatorStatus()" style="background: #9b59b6; color: white;">
                        üîß Fix Status
                    </button>
                </div>
                <div id="pendingRequests"></div>
                <div id="teamList"></div>
                
                <!-- Debug info -->
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 12px;">
                    <strong>üîç Debug Info:</strong>
                    <div id="debugInfo">Caricamento...</div>
                </div>
            </div>
        </div>

        <button class="fab" onclick="openEventModal()">+</button>
    </div>

    <!-- Event Modal -->
    <div class="modal" id="eventModal">
        <div class="modal-content">
            <h2 class="modal-title">üìÖ Nuovo Evento</h2>
            
            <div class="form-group">
                <label class="form-label">Data Evento</label>
                <input type="date" class="form-input" id="eventDate">
            </div>
            
            <div class="form-group">
                <label class="form-label">Ora Inizio</label>
                <input type="time" class="form-input" id="eventTime">
            </div>
            
            <div class="form-group">
                <label class="form-label">Tipo Evento</label>
                <select class="form-select" id="eventType">
                    <option>Compleanno Bambini</option>
                    <option>Compleanno Adulti</option>
                    <option>Matrimonio</option>
                    <option>Evento Aziendale</option>
                    <option>Festa Privata</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Indirizzo</label>
                <input type="text" class="form-input" id="eventAddress" placeholder="Via/Piazza...">
            </div>
            
            <div class="form-group">
                <label class="form-label">Animatori Assegnati</label>
                <select class="form-select" id="eventAnimators" multiple style="height: 100px;">
                    <!-- Will be populated dynamically -->
                </select>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="closeModal('eventModal')">Annulla</button>
                <button class="btn-modal btn-save" onclick="saveEvent()">Salva Evento</button>
            </div>
        </div>
    </div>

    <!-- Animator Modal -->
    <div class="modal" id="animatorModal">
        <div class="modal-content">
            <h2 class="modal-title">üë§ Nuovo Animatore</h2>
            
            <div class="form-group">
                <label class="form-label">Nome Completo</label>
                <input type="text" class="form-input" id="animatorFullName" placeholder="Nome e Cognome">
            </div>
            
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-input" id="animatorEmail" placeholder="nome@esempio.com">
            </div>
            
            <div class="form-group">
                <label class="form-label">Telefono</label>
                <input type="tel" class="form-input" id="animatorPhone" placeholder="+39 333 1234567">
            </div>
            
            <div class="form-group">
                <label class="form-label">Ruolo</label>
                <select class="form-select" id="animatorRole">
                    <option>Animatore Junior</option>
                    <option>Animatore Senior</option>
                    <option>Capo Animatore</option>
                </select>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="closeModal('animatorModal')">Annulla</button>
                <button class="btn-modal btn-save" onclick="saveAnimator()">Salva Animatore</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div>
            <div style="font-weight: 600;" id="notificationTitle">Notifica</div>
            <div style="font-size: 14px; color: #7f8c8d;" id="notificationMessage">Messaggio</div>
        </div>
    </div>

    <!-- Firebase Status -->
    <div class="firebase-status" id="firebaseStatus">üî• Connessione Firebase...</div>

    <!-- Firebase Module Script -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDSG_YYQdxWM_OXbCZNBuNKzCEV6P5vZtQ",
            authDomain: "sorrentino-turni.firebaseapp.com",
            projectId: "sorrentino-turni",
            storageBucket: "sorrentino-turni.firebasestorage.app",
            messagingSenderId: "265460676714",
            appId: "1:265460676714:web:d88b4db67d2f95ae653213",
            measurementId: "G-QDWCVYXVR2"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global variables
        window.db = db;
        window.auth = auth;
        window.currentUser = null;

        function updateFirebaseStatus(message, status = '') {
            const statusEl = document.getElementById('firebaseStatus');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = `firebase-status ${status}`;
            }
        }

        // Initialize app
        function initializeAppData() {
            updateFirebaseStatus('üîÑ Connessione in corso...', 'connecting');
            
            const timeout = setTimeout(() => {
                updateFirebaseStatus('‚ùå Timeout connessione', 'error');
                showLoginScreen();
            }, 10000);
            
            onAuthStateChanged(auth, (user) => {
                clearTimeout(timeout);
                if (user) {
                    updateFirebaseStatus('‚úÖ Connesso', 'connected');
                    handleAuthenticatedUser(user);
                } else {
                    updateFirebaseStatus('üîê Non autenticato', 'error');
                    showLoginScreen();
                }
            });

            setTimeout(createAdminIfNotExists, 2000);
        }

        function handleAuthenticatedUser(user) {
            if (user.email === 'admin@sorrentino.it') {
                window.currentUser = { type: 'admin', email: user.email, name: 'Amministratore', uid: user.uid };
                showAdminApp();
            } else {
                loadAnimatorData(user);
            }
        }

        async function loadAnimatorData(user) {
            try {
                const animatorsRef = collection(db, 'animators');
                const q = query(animatorsRef, where('email', '==', user.email));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    const animatorDoc = querySnapshot.docs[0];
                    const animatorData = animatorDoc.data();
                    
                    if (animatorData.status === 'approved') {
                        window.currentUser = {
                            type: 'animator',
                            email: user.email,
                            name: animatorData.name,
                            uid: user.uid,
                            id: animatorDoc.id
                        };
                        // Would show animator app here
                        showNotification('Benvenuto', 'App animatori in sviluppo');
                    } else {
                        showNotification('Account in Attesa', 'Il tuo account √® in attesa di approvazione');
                        await signOut(auth);
                    }
                } else {
                    showNotification('Errore', 'Animatore non trovato');
                    await signOut(auth);
                }
            } catch (error) {
                console.error('Error loading animator:', error);
                showNotification('Errore', 'Errore nel caricamento dati');
                await signOut(auth);
            }
        }

        function showLoginScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminApp').style.display = 'none';
        }

        function showAdminApp() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminApp').style.display = 'block';
            
            setTimeout(async () => {
                await loadAdminData();
            }, 500);
        }

        async function createAdminIfNotExists() {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, 'admin@sorrentino.it', 'admin123');
                await signOut(auth);
                
                await addDoc(collection(db, 'admins'), {
                    email: 'admin@sorrentino.it',
                    name: 'Amministratore',
                    createdAt: new Date().toISOString()
                });
                
                console.log('Admin account created');
            } catch (error) {
                console.log('Admin might already exist');
            }
        }

        // Authentication functions
        window.login = async function() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showNotification('Errore', 'Compila tutti i campi');
                return;
            }
            
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.disabled = true;
            loginBtn.textContent = 'Accesso...';
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Errore', 'Credenziali non valide');
                loginBtn.disabled = false;
                loginBtn.textContent = 'Accedi';
            }
        };

        window.logout = async function() {
            await signOut(auth);
        };

        // Load admin data
        async function loadAdminData() {
            try {
                await Promise.all([
                    loadAdminDashboard(),
                    loadEvents(),
                    loadTeam()
                ]);
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        async function loadAdminDashboard() {
            document.getElementById('todayEvents').textContent = '0';
            document.getElementById('activeAnimators').textContent = '0'; 
            document.getElementById('monthHours').textContent = '0h';
        }

        async function loadEvents() {
            try {
                const eventsRef = collection(db, 'events');
                const querySnapshot = await getDocs(eventsRef);
                
                const eventsList = document.getElementById('eventsList');
                const noEvents = document.getElementById('noEvents');
                
                if (querySnapshot.empty) {
                    eventsList.innerHTML = '';
                    noEvents.style.display = 'block';
                } else {
                    noEvents.style.display = 'none';
                    const events = [];
                    querySnapshot.docs.forEach(doc => {
                        events.push({ id: doc.id, ...doc.data() });
                    });
                    
                    eventsList.innerHTML = events.map(event => `
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                            <h3>${event.type} - ${event.date}</h3>
                            <p>üìç ${event.address}</p>
                            <p>üë• ${event.animators?.map(a => a.name).join(', ') || 'Nessun animatore'}</p>
                            <button onclick="deleteEvent('${event.id}')" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin-top: 10px;">
                                üóëÔ∏è Elimina
                            </button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        async function loadTeam() {
            try {
                console.log('üîÑ Loading team...');
                const animatorsRef = collection(db, 'animators');
                const querySnapshot = await getDocs(animatorsRef);
                
                const pendingAnimators = [];
                const approvedAnimators = [];
                
                querySnapshot.docs.forEach(docData => {
                    const animator = { id: docData.id, ...docData.data() };
                    
                    if (animator.status === 'pending') {
                        pendingAnimators.push(animator);
                    } else if (animator.status === 'approved') {
                        approvedAnimators.push(animator);
                    }
                });
                
                // Update debug info
                const debugInfo = document.getElementById('debugInfo');
                if (debugInfo) {
                    debugInfo.innerHTML = `
                        üìä Totale animatori: ${querySnapshot.docs.length}<br>
                        ‚è≥ In attesa: ${pendingAnimators.length}<br>
                        ‚úÖ Approvati: ${approvedAnimators.length}<br>
                        üîÑ Ultimo aggiornamento: ${new Date().toLocaleTimeString()}
                    `;
                }
                
                const teamList = document.getElementById('teamList');
                const pendingRequests = document.getElementById('pendingRequests');
                
                if (pendingRequests && pendingAnimators.length > 0) {
                    pendingRequests.innerHTML = `
                        <h3 style="margin-bottom: 15px; color: #e67e22;">‚è≥ Richieste in Attesa (${pendingAnimators.length})</h3>
                        ${pendingAnimators.map(pending => `
                            <div class="animator-item" style="border-left: 4px solid #f39c12;">
                                <div>
                                    <div class="animator-name">${pending.name}</div>
                                    <div style="font-size: 12px; color: #7f8c8d;">${pending.role} - ${pending.email}</div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button onclick="approveAnimator('${pending.id}')" style="background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 5px;">‚úÖ</button>
                                    <button onclick="rejectAnimator('${pending.id}')" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px;">‚ùå</button>
                                </div>
                            </div>
                        `).join('')}
                    `;
                
                if (teamList && approvedAnimators.length > 0) {
                    teamList.innerHTML = approvedAnimators.map(animator => `
                        <div class="animator-item">
                            <div>
                                <div class="animator-name">${animator.name}</div>
                                <div style="font-size: 12px; color: #7f8c8d;">${animator.role} - ${animator.email}</div>
                            </div>
                            <div class="animator-status">Disponibile</div>
                        </div>
                    `).join('');
                } else if (teamList) {
                    teamList.innerHTML = `
                        <div style="text-align: center; padding: 20px; background: #fff3cd; border-radius: 10px; color: #856404;">
                            <p><strong>Nessun animatore approvato</strong></p>
                            <p style="font-size: 14px;">Clicca "Fix Status" per approvare gli animatori esistenti</p>
                        </div>
                    `;
                }
                
                // Refresh event modal animators
                if (window.populateEventAnimators) {
                    await window.populateEventAnimators();
                }
                
            } catch (error) {
                console.error('Error loading team:', error);
                showNotification('Errore', 'Errore nel caricamento team');
            }
        }

        // Populate event modal animators - renamed to avoid conflicts
        async function populateEventAnimators() {
            console.log('Loading animators for event modal...');
            try {
                const animatorsRef = collection(db, 'animators');
                const allQuery = await getDocs(animatorsRef);
                
                const approvedAnimators = [];
                
                allQuery.docs.forEach(docData => {
                    const animator = { id: docData.id, ...docData.data() };
                    
                    const status = animator.status ? animator.status.toString().trim() : '';
                    
                    if (status === 'approved') {
                        approvedAnimators.push(animator);
                    }
                });
                
                const animatorSelect = document.getElementById('eventAnimators');
                
                if (animatorSelect) {
                    if (approvedAnimators.length > 0) {
                        const options = approvedAnimators.map(animator => 
                            `<option value="${animator.id}">${animator.name} - ${animator.role}</option>`
                        ).join('');
                        
                        animatorSelect.innerHTML = options;
                        console.log('Populated animator select with', approvedAnimators.length, 'animators');
                    } else {
                        animatorSelect.innerHTML = `
                            <option disabled style="color: #e74c3c;">Nessun animatore approvato</option>
                            <option disabled style="color: #f39c12;">Vai in Team e clicca "Fix Status"</option>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading animators for event modal:', error);
                const animatorSelect = document.getElementById('eventAnimators');
                if (animatorSelect) {
                    animatorSelect.innerHTML = `<option disabled style="color: #e74c3c;">Errore caricamento</option>`;
                }
            }
        }

        // Admin functions
        window.approveAnimator = async function(animatorId) {
            try {
                const animatorRef = doc(db, 'animators', animatorId);
                await updateDoc(animatorRef, {
                    status: 'approved',
                    workStatus: 'available',
                    approvedAt: new Date().toISOString(),
                    approvedBy: window.currentUser.email
                });
                
                showNotification('Animatore Approvato!', 'Animatore approvato con successo');
                await loadTeam();
            } catch (error) {
                console.error('Error approving animator:', error);
                showNotification('Errore', 'Errore approvazione');
            }
        };

        window.rejectAnimator = async function(animatorId) {
            if (!confirm('Sei sicuro di voler rifiutare questa registrazione?')) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'animators', animatorId));
                showNotification('Registrazione Rifiutata', 'Richiesta eliminata');
                await loadTeam();
            } catch (error) {
                console.error('Error rejecting animator:', error);
                showNotification('Errore', 'Errore eliminazione');
            }
        };

        window.fixAnimatorStatus = async function() {
            try {
                console.log('Fixing animator status...');
                const animatorsRef = collection(db, 'animators');
                const querySnapshot = await getDocs(animatorsRef);
                
                const updatePromises = [];
                querySnapshot.docs.forEach(docSnapshot => {
                    const data = docSnapshot.data();
                    
                    if (!data.status || data.status !== 'approved') {
                        const docRef = doc(db, 'animators', docSnapshot.id);
                        updatePromises.push(updateDoc(docRef, {
                            status: 'approved',
                            workStatus: 'available',
                            approvedAt: new Date().toISOString(),
                            approvedBy: 'admin_fix'
                        }));
                    }
                });
                
                if (updatePromises.length > 0) {
                    await Promise.all(updatePromises);
                    showNotification('Status Aggiornati!', `${updatePromises.length} animatori aggiornati`);
                    await loadTeam();
                } else {
                    showNotification('Tutto OK!', 'Tutti gli animatori sono gi√† approvati');
                }
                
            } catch (error) {
                console.error('Error fixing animator status:', error);
                showNotification('Errore', 'Errore aggiornamento');
            }
        };

        window.saveEvent = async function() {
            try {
                const eventDate = document.getElementById('eventDate').value;
                const eventTime = document.getElementById('eventTime').value;
                const eventType = document.getElementById('eventType').value;
                const eventAddress = document.getElementById('eventAddress').value;
                const animatorSelect = document.getElementById('eventAnimators');
                
                if (!eventDate || !eventTime || !eventAddress) {
                    showNotification('Errore', 'Compila tutti i campi obbligatori');
                    return;
                }
                
                const selectedAnimators = Array.from(animatorSelect.selectedOptions).map(option => ({
                    id: option.value,
                    name: option.textContent
                }));
                
                if (selectedAnimators.length === 0) {
                    showNotification('Errore', 'Seleziona almeno un animatore');
                    return;
                }
                
                const eventData = {
                    date: eventDate,
                    time: eventTime,
                    type: eventType,
                    address: eventAddress,
                    animators: selectedAnimators,
                    status: 'scheduled',
                    createdAt: new Date().toISOString(),
                    createdBy: window.currentUser.email
                };
                
                await addDoc(collection(db, 'events'), eventData);
                
                showNotification('Evento Salvato!', 'Evento creato con successo');
                closeModal('eventModal');
                
                document.getElementById('eventDate').value = '';
                document.getElementById('eventTime').value = '';
                document.getElementById('eventAddress').value = '';
                animatorSelect.selectedIndex = -1;
                
                await loadEvents();
                
            } catch (error) {
                console.error('Error saving event:', error);
                showNotification('Errore', 'Errore nel salvare evento');
            }
        };

        window.saveAnimator = async function() {
            try {
                const name = document.getElementById('animatorFullName').value.trim();
                const email = document.getElementById('animatorEmail').value.trim();
                const phone = document.getElementById('animatorPhone').value.trim();
                const role = document.getElementById('animatorRole').value;
                
                if (!name || !email || !phone) {
                    showNotification('Errore', 'Compila tutti i campi obbligatori');
                    return;
                }
                
                await addDoc(collection(db, 'animators'), {
                    name: name,
                    email: email,
                    phone: phone,
                    role: role,
                    status: 'approved',
                    workStatus: 'available',
                    source: 'admin_manual',
                    registeredAt: new Date().toISOString(),
                    approvedAt: new Date().toISOString(),
                    approvedBy: window.currentUser.email
                });
                
                showNotification('Animatore Aggiunto!', `${name} aggiunto al team`);
                closeModal('animatorModal');
                
                document.getElementById('animatorFullName').value = '';
                document.getElementById('animatorEmail').value = '';
                document.getElementById('animatorPhone').value = '';
                
                await loadTeam();
                
            } catch (error) {
                console.error('Error saving animator:', error);
                showNotification('Errore', 'Errore nel salvare animatore');
            }
        };

        window.deleteEvent = async function(eventId) {
            if (!confirm('Sei sicuro di voler eliminare questo evento?')) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'events', eventId));
                showNotification('Evento Eliminato', 'Evento rimosso');
                await loadEvents();
            } catch (error) {
                console.error('Error deleting event:', error);
                showNotification('Errore', 'Errore eliminazione evento');
            }
        };

        // Make functions globally available
        window.loadTeam = loadTeam;
        window.populateEventAnimators = populateEventAnimators;

        // Initialize when page loads
        window.onload = function() {
            setTimeout(initializeAppData, 1000);
        };

    </script>

    <script>
        // Fallback functions to prevent ReferenceError
        window.populateEventAnimators = window.populateEventAnimators || function() {
            console.log('Fallback: Module not ready yet');
            const select = document.getElementById('eventAnimators');
            if (select) {
                select.innerHTML = '<option disabled>Caricamento in corso...</option>';
            }
        };

        window.loadTeam = window.loadTeam || function() {
            console.log('Fallback: Module not ready yet');
            showNotification('Caricamento', 'Sistema in inizializzazione...');
        };

        // UI Helper functions
        function updateLoginHint() {
            const userType = document.getElementById('userType').value;
            const hint = document.getElementById('loginHint');
            const hintText = hint.querySelector('small');
            
            if (userType === 'admin') {
                hintText.innerHTML = 'admin@sorrentino.it<br>admin123';
                hint.style.display = 'block';
            } else if (userType === 'animator') {
                hintText.innerHTML = 'Usa la tua email di registrazione<br>La password che hai scelto';
                hint.style.display = 'block';
            } else {
                hint.style.display = 'none';
            }
        }

        function switchTab(tabName, appType) {
            const prefix = appType === 'admin' ? 'admin-' : 'animator-';
            const app = appType === 'admin' ? 'adminApp' : 'animatorApp';
            
            document.querySelectorAll(`#${app} .tab`).forEach(t => t.classList.remove('active'));
            document.querySelectorAll(`#${app} .section`).forEach(s => s.classList.remove('active'));
            
            event.target.classList.add('active');
            const section = document.getElementById(prefix + tabName);
            if (section) section.classList.add('active');
        }

        function showNotification(title, message) {
            const notification = document.getElementById('notification');
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationMessage').textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function openEventModal() {
            document.getElementById('eventModal').classList.add('active');
            document.getElementById('eventDate').valueAsDate = new Date();
            
            if (window.populateEventAnimators) {
                window.populateEventAnimators();
            }
        }

        function openAnimatorModal() {
            document.getElementById('animatorModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Close modals when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
        });

        // Make global functions available
        window.updateLoginHint = updateLoginHint;
        window.switchTab = switchTab;
        window.openEventModal = openEventModal;
        window.openAnimatorModal = openAnimatorModal;
        window.closeModal = closeModal;
        window.showNotification = showNotification;
    </script>
</body>
</html>
